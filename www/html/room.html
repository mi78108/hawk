<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>Room</title>
    <script src="/pub/js/baseFunc.js"></script>
    <script src="/pub/js/xterm.js"></script>
    <script src="/pub/js/ws.js"></script>
</head>
<body style="width: 98%;height: 85%">
<!--Input Room ID <input id="room_id">-->
<div style="margin: 5% auto;padding: 2%;background-color: bisque;width: 90%;height: 80%">
    <div id="o_m" style="overflow-y: auto;width: 96%;margin:auto;height: 70%;background-color: #000">
    </div>
    <div id="i_m" contenteditable="true"
         style="width: 96%;margin-top: 2%;margin-left: auto;margin-right:auto;height: 24%;background-color: aliceblue">
        <textarea style="width: 100%;height: 100%"></textarea>
    </div>
</div>
</body>
<script>
    jQuery(function ($, undefined) {
        if ("WebSocket" in window) {
            let wse = new wsExt(window.location.href.replace(/^(http|https)/, "ws"));
            wse.ws.onopen = function () {
                $("#o_m").get(0).style.border = "3px green solid";
                $("#o_m").get(0).style.boxShadow = "-0px -0px 5px 5px green";
                wse.re_try = 7;
                setInterval(function () {
                    //
                    let r = _get_added('ctrl_ping_count');
                    wse.ws.send('CTRL_PING_' + r);
                    log("Ping");
                    if (r > 78) {
                        _get_added('ctrl_ping_count', function (v) {
                            v.v = 0;
                        });
                    }
                }, 30000)
            };
            let tm = $('#o_m').Xterm({
                prompt: " > "
            }, function (command) {
                if (command === 'video') {
                    document.body.appendChild(get_local_video("wc"));
                }
                wse.ws.send(command)
            });

            wse.ws.onmessage = function (evt) {
                let received_msg = evt.data;
                log(received_msg);
                if (received_msg.startsWith("CTRL_")) {
                    log(received_msg);
                } else {
                    if(received_msg.startsWith('{') && received_msg.endsWith('}')){
                        let js = JSON.parse(received_msg);
                        let info = "客户端: "+js.ev_client_addr+" ["+js.ev_type+"] 当前在线: "+js.clients;
                        $("#i_m").children("textarea").append(info+"                "+tm.last_cb()+"\n");
                    }else {
                        tm.echo(received_msg);
                    }
                }
            };

            wse.ws.onclose = function (evt) {
                //alert("We Lost WS connect Ready To Reconnect...");
                $("#o_m").get(0).style.boxShadow = "-0px -0px 5px 5px red";
                $("#o_m").get(0).style.border = "3px red solid";
                if (wse.re_try > 0) {
                    setTimeout(function () {
                        wse.reconnect();
                    }, 3000);
                }
                wse.re_try--;
            };
        } else {
            alert("浏览器 不支持 WebSocket")
        }
    });
</script>
<script>
</script>
</html>